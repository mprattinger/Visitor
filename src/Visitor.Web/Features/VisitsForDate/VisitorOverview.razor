@using Visitor.Web.Features.VisitsForDate
@using Visitor.Web.Common.Interfaces
@implements IDisposable

<div class="container">
    <VisitorOverviewHeader OnChange="loadVisitData" ForDate="DateTime.Now.Date" />
    
    @if (dashboardData == null)
    {
        <p><em>Loading...</em></p>
    }
    else
    {
        <VisitorOverviewSections Data="dashboardData" OnChange="loadVisitData" />
    }
</div>

@code {
    @inject IQueryHandler<GetVisitsForDate.Query, DashboardDataDTO> getDashboardDataQueryHandler;
    @inject IVisitorUpdateNotifier visitorUpdateNotifier;
    
    private DashboardDataDTO? dashboardData;
    

    [CascadingParameter]
    public ApplicationContext? Context { get; set; }

    protected override async Task OnInitializedAsync()
    {
        await loadVisitData();
        
        // Subscribe to visitor updates
        visitorUpdateNotifier.OnVisitorUpdated += HandleVisitorUpdate;
    }

    void HandleVisitorUpdate()
    {
        InvokeAsync(async () =>
        {
            await loadVisitData();
            StateHasChanged();
        });
    }

    async Task loadVisitData()
    {
        var result = await getDashboardDataQueryHandler.Handle(new GetVisitsForDate.Query(DateTime.Now.Date), CancellationToken.None);

        if (result.IsError)
        {
            var firstError = result.Errors.FirstOrDefault();
            Context?.AddError(firstError.Description ?? "An unknown error occurred.");
            return;
        }
        
        dashboardData = result.Value;
    }

    public void Dispose()
    {
        visitorUpdateNotifier.OnVisitorUpdated -= HandleVisitorUpdate;
    }
}
