@page "/dashboard"
@using FlintSoft.CQRS.Interfaces
@using Visitor.Web.Features.DashboardHome
@using Visitor.Web.Features.DashboardHome.Components

@rendermode InteractiveServer

<PageTitle>Dashboard - Visitor Overview</PageTitle>

<div class="dashboard-container">
    <h3>Dashboard - Visitor Overview</h3>
    <p class="dashboard-subtitle">Status for @DateTime.UtcNow.ToString("dddd, dd MMMM yyyy")</p>
    @if (dashboardData == null)
    {
        <p><em>Loading...</em></p>
    }
    else if (errorMessage != null)
    {
        <div class="alert alert-danger">@errorMessage</div>
    }
    else
    {
        <div class="visitor-sections">
            <div class="visitor-section planned">
                <h4>Geplant</h4>
                @foreach (var v in dashboardData.PlannedVisitors)
                {
                    <VisitorInfo VisitorSummary="v" />
                }
            </div>
            <div class="visitor-section active">
                <h4>Im Haus</h4>
                @foreach (var v in dashboardData.CurrentlyVisiting)
                {
                    <VisitorInfo VisitorSummary="v" />
                }
            </div>
            <div class="visitor-section left">
                <h4>Beendet</h4>
                @foreach(var v in dashboardData.AlreadyLeft)
                {
                    <VisitorInfo VisitorSummary="v" />
                }
            </div>
        </div>
    }
</div>

@code {
    @inject FlintSoft.CQRS.Handlers.IQueryHandler<GetDashboardData.Query, DashboardDataDTO> getDashboardDataQueryHandler;

    private DashboardDataDTO? dashboardData;
    private string? errorMessage;

    protected override async Task OnInitializedAsync()
    {
        await LoadDashboardData();
    }

    private async Task LoadDashboardData()
    {
        var result = await getDashboardDataQueryHandler.Handle(new GetDashboardData.Query(), CancellationToken.None);
        
        if (result.IsError)
        {
            var firstError = result.Errors.FirstOrDefault();
            errorMessage = firstError.Description ?? "An unknown error occurred.";
        }
        else
        {
            dashboardData = result.Value;
        }
    }
}
