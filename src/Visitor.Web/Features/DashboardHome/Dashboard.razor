@page "/dashboard"
@using FlintSoft.CQRS.Interfaces
@using Visitor.Web.Features.DashboardHome
@using Visitor.Web.Features.DashboardHome.Components

@rendermode InteractiveServer
@inject NavigationManager Navigation

<PageTitle>Dashboard - Visitor Overview</PageTitle>

<div class="dashboard-container">
    <div class="dashboard-header">
        <div>
            <h3>Dashboard - Visitor Overview</h3>
            <p class="dashboard-subtitle">Status for @DateTime.UtcNow.ToString("dddd, dd MMMM yyyy")</p>
        </div>
        <div class="action-buttons">
            <button class="btn-action btn-plan" @onclick="OpenPlanVisitModal">Besuch planen</button>
            <button class="btn-action btn-selfservice" @onclick="OpenSelfService">Self-Service</button>
        </div>
    </div>

    <PlanVisitModal IsVisible="showPlanModal" 
                    OnVisitPlanned="OnVisitPlanned" 
                    OnClose="ClosePlanVisitModal" />
    @if (dashboardData == null)
    {
        <p><em>Loading...</em></p>
    }
    else if (errorMessage != null)
    {
        <div class="alert alert-danger">@errorMessage</div>
    }
    else
    {
        <div class="visitor-sections">
            <div class="visitor-section planned">
                <h4>Geplant</h4>
                @foreach (var v in dashboardData.PlannedVisitors)
                {
                    <VisitorInfo VisitorSummary="v" />
                }
            </div>
            <div class="visitor-section active">
                <h4>Im Haus</h4>
                @foreach (var v in dashboardData.CurrentlyVisiting)
                {
                    <VisitorInfo VisitorSummary="v" />
                }
            </div>
            <div class="visitor-section left">
                <h4>Beendet</h4>
                @foreach(var v in dashboardData.AlreadyLeft)
                {
                    <VisitorInfo VisitorSummary="v" />
                }
            </div>
        </div>
    }
</div>

@code {
    @inject FlintSoft.CQRS.Handlers.IQueryHandler<GetDashboardData.Query, DashboardDataDTO> getDashboardDataQueryHandler;

    private DashboardDataDTO? dashboardData;
    private string? errorMessage;
    private bool showPlanModal = false;

    protected override async Task OnInitializedAsync()
    {
        await LoadDashboardData();
    }

    private async Task LoadDashboardData()
    {
        var result = await getDashboardDataQueryHandler.Handle(new GetDashboardData.Query(), CancellationToken.None);
        
        if (result.IsError)
        {
            var firstError = result.Errors.FirstOrDefault();
            errorMessage = firstError.Description ?? "An unknown error occurred.";
        }
        else
        {
            dashboardData = result.Value;
        }
    }

    private void OpenPlanVisitModal()
    {
        showPlanModal = true;
    }

    private void ClosePlanVisitModal()
    {
        showPlanModal = false;
    }

    private async Task OnVisitPlanned()
    {
        await LoadDashboardData();
    }

    private void OpenSelfService()
    {
        Navigation.NavigateTo("/kiosk");
    }
}
