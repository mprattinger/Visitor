@page "/kiosk"
@using FlintSoft.CQRS.Handlers
@using Visitor.Web.Common.Layout
@using Visitor.Web.Features.VisitorManagement.DomainEntities
@using Visitor.Web.Common.Buttons

@layout KioskLayout

<div class="title">
    Willkommen, bitte melden Sie sich an
</div>

@if (Model is not null)
{
    <EditForm EditContext="editContext" OnValidSubmit="submit" FormName="kiosk-form">
        <AntiforgeryToken />
        <DataAnnotationsValidator />

        <div class="container">

            <div class="input-wrapper autocomplete-wrapper">
                <input type="text" id="nameInput" placeholder=" " 
                      value="@Model.Name"
                       @onfocus="OnNameFocus"
                       @onblur="OnNameBlur"
                        @oninput="@(e => OnNameInput(e))">
                <label for="nameInput">Name</label>
                <ValidationMessage For="@(() => Model.Name)" />
                
                @if (showDropdown && searchResults.Any())
                {
                    <div class="autocomplete-dropdown">
                        @foreach (var visitor in searchResults)
                        {
                            <div class="autocomplete-item" @onmousedown="@(() => SelectVisitor(visitor))">
                                <div class="visitor-name">@visitor.Name</div>
                                <div class="visitor-company">@visitor.Company</div>
                            </div>
                        }
                    </div>
                }
            </div>

            <div class="input-wrapper">
                <input type="text" id="companyInput" placeholder=" " @bind-value="Model.Company">
                <label for="companyInput">Firma</label>
                <ValidationMessage For="@(() => Model.Company)" />
            </div>

            <div class="button-row">
                <SecondaryButton ButtonType="button" OnClick="cancel">Abbrechen</SecondaryButton>
                <PrimaryButton ButtonType="submit">Anmelden</PrimaryButton>
                @* <StandardButton ButtonType="submit">Anmelden</StandardButton>
                <StandardButton OnClick="cancel">Abbrechen</StandardButton> *@
            </div>

        </div>

    </EditForm>
}
@code {
    @inject ICommandHandler<CreateVisitKiosk.Command, VisitorEntity> createVisitKioskCommandHandler;
    @inject IQueryHandler<SearchPlannedVisitors.Query, List<VisitorSearchResultDTO>> searchPlannedVisitorsQueryHandler;

    private EditContext? editContext;
    private List<VisitorSearchResultDTO> searchResults = new();
    private bool showDropdown = false;

    [SupplyParameterFromForm]
    private VisitorDTO? Model { get; set; }

    override protected void OnInitialized()
    {
        if (Model == null)
        {
            Model = new VisitorDTO();
        }
        editContext = new EditContext(Model);
    }

    private async Task OnNameInput(ChangeEventArgs e)
    {
        var searchTerm = e.Value?.ToString() ?? string.Empty;
        Model!.Name = searchTerm;

        if (searchTerm.Length >= 3)
        {
            var result = await searchPlannedVisitorsQueryHandler.Handle(
                new SearchPlannedVisitors.Query(searchTerm), 
                CancellationToken.None);

            if (!result.IsError)
            {
                searchResults = result.Value;
                showDropdown = searchResults.Any();
            }
        }
        else
        {
            searchResults.Clear();
            showDropdown = false;
        }

        StateHasChanged();
    }

    private void OnNameFocus()
    {
        if (searchResults.Any() && !string.IsNullOrWhiteSpace(Model?.Name) && Model.Name.Length >= 3)
        {
            showDropdown = true;
        }
    }

    private void OnNameBlur()
    {
        // Delay to allow click events to fire
        Task.Delay(200).ContinueWith(_ =>
        {
            showDropdown = false;
            InvokeAsync(StateHasChanged);
        });
    }

    private void SelectVisitor(VisitorSearchResultDTO visitor)
    {
        Model!.Id = visitor.Id;
        Model.Name = visitor.Name;
        Model.Company = visitor.Company;
        searchResults.Clear();
        showDropdown = false;
        StateHasChanged();
    }

    async Task submit()
    {
        var result = await createVisitKioskCommandHandler.Handle(
            new CreateVisitKiosk.Command(Model!.Name, Model!.Company, Model.Id), 
            CancellationToken.None);
        if(result.IsError)
        {
            return;
        }

        Model = new VisitorDTO();
        editContext = new EditContext(Model);
    }

    void cancel()
    {
        Model = new VisitorDTO();
        editContext = new EditContext(Model);
        editContext.MarkAsUnmodified(); // Clear validation messages
        searchResults.Clear();
        showDropdown = false;
        StateHasChanged();
    }
}